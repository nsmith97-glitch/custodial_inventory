<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Custodial Inventory – Taconic Hills (Sheets)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ea580c">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html, body, #root { height: 100%; }</style>
</head>
<body>
  <div id="root"></div>
  <script>
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  </script>

  <script type="text/babel">
    const {useState, useEffect, useMemo} = React;

    // Injected config
    const API_BASE = "https://script.google.com/macros/s/AKfycbwgCj932pkE8Pcp-YTI2vHd35axct-8OXMvukSG-il1JRO7qImb-IiNwLn_jif-OIJwLA/exec";
    const API_TOKEN = "thcsd-2025-custodial-inventory-4908";

    async function apiGet(route) {
      const url = `${API_BASE}?route=${encodeURIComponent(route)}&token=${encodeURIComponent(API_TOKEN)}`;
      const res = await fetch(url, { method: 'GET' });
      return res.json();
    }
    async function apiPost(action, payload) {
      const url = `${API_BASE}?token=${encodeURIComponent(API_TOKEN)}`;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ action, ...payload })
      });
      return res.json();
    }

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    const categories = ["Cleaning Chemicals","Paper Products","Trash Bags","Equipment","Miscellaneous"];

    function useLocalStorage(key, initial) {
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial; } catch { return initial; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
      return [state, setState];
    }

    function ItemForm({ initial, onSave, onCancel }) {
      const [item, setItem] = useState(initial);
      const setField = (k,v) => setItem(p => ({...p, [k]:v}));
      return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl p-4 max-w-md w-full text-gray-900">
            <h2 className="text-xl mb-2">{initial.id ? "Edit" : "New"} Item</h2>
            <input className="border p-2 w-full mb-2" value={item.name} onChange={e=>setField("name", e.target.value)} placeholder="Name"/>
            <select className="border p-2 w-full mb-2" value={item.category} onChange={e=>setField("category", e.target.value)}>
              {categories.map(c=><option key={c} value={c}>{c}</option>)}
            </select>
            <input className="border p-2 w-full mb-2" type="number" value={item.quantity} onChange={e=>setField("quantity", Number(e.target.value||0))} placeholder="Quantity"/>
            <input className="border p-2 w-full mb-2" value={item.location} onChange={e=>setField("location", e.target.value)} placeholder="Location"/>
            <input className="border p-2 w-full mb-2" value={item.vendor} onChange={e=>setField("vendor", e.target.value)} placeholder="Vendor"/>
            <div className="flex justify-end gap-2">
              <button onClick={onCancel} className="px-3 py-1 bg-gray-200 rounded">Cancel</button>
              <button onClick={()=>onSave(item)} className="px-3 py-1 bg-emerald-600 text-white rounded">Save</button>
            </div>
          </div>
        </div>
      );
    }

    function ItemCard({item, onEdit, onDelete, onAdjust}) {
      return (
        <div className="bg-white rounded-xl p-4 text-gray-900 shadow">
          <h3 className="font-bold">{item.name}</h3>
          <p>{item.category}</p>
          <p>Qty: {item.quantity}</p>
          <div className="flex gap-2 mt-2">
            <button onClick={()=>onAdjust(item,1,'receive')} className="px-2 py-1 bg-emerald-600 text-white rounded">+1</button>
            <button onClick={()=>onAdjust(item,-1,'issue')} className="px-2 py-1 bg-amber-600 text-white rounded">-1</button>
            <button onClick={()=>onEdit(item)} className="px-2 py-1 bg-gray-200 rounded">Edit</button>
            <button onClick={()=>onDelete(item)} className="px-2 py-1 bg-rose-600 text-white rounded">Delete</button>
          </div>
        </div>
      );
    }

    function App() {
      const [items, setItems] = useLocalStorage("custodial_inventory_v1", []);
      const [editing, setEditing] = useState(null);
      const [loading, setLoading] = useState(false);

      useEffect(()=>{(async()=>{setLoading(true);const r=await apiGet('items');if(r.ok) setItems(r.items);setLoading(false);})()},[]);

      const saveItem = async (item)=>{
        const withId = item.id||uid();
        const updated={...item,id:withId};
        setItems(prev=>prev.some(i=>i.id===withId)?prev.map(i=>i.id===withId?updated:i):[updated,...prev]);
        await apiPost('upsertItem',{item:updated});
        setEditing(null);
      };

      const deleteItem = async (item)=>{
        setItems(prev=>prev.filter(i=>i.id!==item.id));
        await apiPost('deleteItem',{id:item.id});
      };

      const adjustQuantity = async (item,change,type)=>{
        const updated={...item,quantity:(item.quantity||0)+change};
        setItems(prev=>prev.map(i=>i.id===item.id?updated:i));
        await apiPost('upsertItem',{item:updated});
        await apiPost('recordTx',{itemId:item.id,change,type});
      };

      return (
        <div className="min-h-screen bg-gradient-to-b from-orange-600 to-orange-800 text-white p-4">
          <div className="max-w-4xl mx-auto">
            <header className="flex items-center gap-3 mb-4">
              <img src="./assets/thcsd-logo.png" alt="THCSD" className="w-10 h-10 bg-white rounded-full p-1" onError={(e)=>{e.currentTarget.style.display='none'}}/>
              <h1 className="text-2xl font-bold">Custodial Inventory</h1>
            </header>
            {loading && <p>Loading…</p>}
            <div className="grid gap-3 sm:grid-cols-2">
              {items.map(it=><ItemCard key={it.id} item={it} onEdit={setEditing} onDelete={deleteItem} onAdjust={adjustQuantity}/>)}
            </div>
            {editing && <ItemForm initial={editing} onSave={saveItem} onCancel={()=>setEditing(null)}/>}
            <button onClick={()=>setEditing({id:"",name:"",category:categories[0],quantity:0,location:"",vendor:""})} className="mt-4 px-4 py-2 bg-white text-gray-900 rounded">+ New Item</button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
