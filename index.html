<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Custodial Inventory – Taconic Hills</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <meta name="theme-color" content="#ea580c">

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM UMD + Babel for in-browser JSX -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body, #root { height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>

  <script type="text/babel">
    const {useState, useEffect, useMemo, useRef} = React;

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    const categories = ["Cleaning Chemicals","Paper Products","Trash Bags","Equipment","Miscellaneous"];

    const SEED_ITEMS = [
      { name: "Facial Tissue", category: "Paper Products" },
      { name: "Feminine Pads", category: "Miscellaneous" },
      { name: "Feminine Tampons", category: "Miscellaneous" },
      { name: "Wax Liners #77", category: "Trash Bags" },
      { name: "Urinal Screens", category: "Miscellaneous" },
      { name: "Doodlebug Pads", category: "Equipment" },
      { name: "Doodlebug Kit", category: "Equipment" },
      { name: "Sponge w/Green Scrubby", category: "Miscellaneous" },
      { name: "Green Utility Pads", category: "Equipment" },
      { name: "Rags", category: "Miscellaneous" },
      { name: "Short Handle Broom", category: "Equipment" },
      { name: "Angle Broom w/Handle", category: "Equipment" },
      { name: "Angle Poly Broom", category: "Equipment" },
      { name: "Lobby Dust Pan", category: "Equipment" },
      { name: "Spray Maker", category: "Equipment" },
      { name: "Spray Bottle", category: "Equipment" },
      { name: "1 Oz. Pump for 1 Gal. Container", category: "Equipment" },
      { name: "1 Oz. Pump for 5 Gal. Pail", category: "Equipment" },
      { name: "Feather Duster", category: "Equipment" },
      { name: "Duster Long Handle", category: "Equipment" },
      { name: "Toilet Brushes", category: "Equipment" },
      { name: "Toilet Mops (Swabby)", category: "Equipment" },
      { name: "Plunger", category: "Equipment" },
      { name: "Classroom Waste Basket", category: "Equipment" },
      { name: "Wet Floor Sign", category: "Equipment" },
      { name: "Treated Dust Cloths", category: "Miscellaneous" },
      { name: "Toilet Tissue", category: "Paper Products" },
      { name: "Brown Towels", category: "Paper Products" },
      { name: "GoJo", category: "Cleaning Chemicals" },
      { name: "Castex Port A Pack (1)", category: "Equipment" },
      { name: "Super Coach (3)", category: "Equipment" },
      { name: "Windsor, Sensor", category: "Equipment" },
      { name: "Sanitaire Com. Wide Trac", category: "Equipment" },
      { name: "#73 G Force Stripper", category: "Cleaning Chemicals" },
      { name: "G Force Finish", category: "Cleaning Chemicals" },
      { name: "Graffiti Remover", category: "Cleaning Chemicals" },
      { name: "Gum Remover", category: "Cleaning Chemicals" },
      { name: "Stainless Steel Cleaner", category: "Cleaning Chemicals" },
      { name: "Foam Carpet Control", category: "Cleaning Chemicals" },
      { name: "Foam Control Hard Surface", category: "Cleaning Chemicals" },
      { name: "Furniture Polish", category: "Cleaning Chemicals" },
      { name: "Finish Mop", category: "Equipment" },
      { name: "16 Oz. Cotton Wet Mop", category: "Equipment" },
      { name: "20 Oz. Synthetic Wet Mop", category: "Equipment" },
      { name: "24 Oz. Cotton Wet Mop", category: "Equipment" },
      { name: "24 Oz. Synthetic Wet Mop", category: "Equipment" },
      { name: "24” Dust Mop", category: "Equipment" },
      { name: "48” Dust Mop", category: "Equipment" },
      { name: "60” Dust Mop", category: "Equipment" },
      { name: "13” White Floor Pad", category: "Equipment" },
      { name: "14” White Floor Pad", category: "Equipment" },
      { name: "13” Red Floor Pad", category: "Equipment" },
      { name: "13” Black Floor Pad", category: "Equipment" },
      { name: "14” Red Floor Pad", category: "Equipment" },
      { name: "14” Blue Floor Pad", category: "Equipment" },
      { name: "20” Pink Burnish Pad", category: "Equipment" },
      { name: "20” Natural Burnish Pad", category: "Equipment" },
      { name: "20” Green Floor Pad", category: "Equipment" },
      { name: "20” Blue Floor Pad", category: "Equipment" },
      { name: "20” Black Floor Pad", category: "Equipment" },
      { name: "20” Hi Pro Black Floor Pad", category: "Equipment" },
      { name: "Strip Pads", category: "Equipment" },
      { name: "21” Ultra High Speed Pad", category: "Equipment" },
      { name: "27” Aqua Burnish Pad", category: "Equipment" },
      { name: "Solo 3 ounce cups #44", category: "Miscellaneous" },
      { name: "ProTeam Micro Filter Bags", category: "Equipment" },
      { name: "Purell Foam Sanitizer", category: "Cleaning Chemicals" },
      { name: "24” x 33” Trash Liners", category: "Trash Bags" },
      { name: "40” x 46” Trash Liners", category: "Trash Bags" },
      { name: "Clairol Alcohol Free Foam Hand Sanitizer", category: "Cleaning Chemicals" },
      { name: "Buckeye Eco E23 Neutral Disinfectant – 1.25 L", category: "Cleaning Chemicals" },
      { name: "Buckeye Eco E15 Hydrogen Peroxide Cleaner – 1.25 L", category: "Cleaning Chemicals" },
      { name: "Buckeye Eco E32 Floor Cleaner – 1.25 L", category: "Cleaning Chemicals" },
      { name: "Buckeye Castleguard Floor Finish – 5 Gal. Box", category: "Cleaning Chemicals" },
      { name: "Buckeye Eco E22 – 1.25 L", category: "Cleaning Chemicals" },
    ];

    const preloadItems = SEED_ITEMS.slice(0, 8).map(s => ({
      id: uid(), name: s.name, category: s.category,
      quantity: 0, location: "", vendor: "", unitCost: "", minQty: 0, notes: ""
    }));

    const emptyItem = () => ({ id: uid(), name: "", category: categories[0], quantity: 0, location: "", vendor: "", unitCost: "", minQty: 0, notes: "" });

    function useLocalStorage(key, initial) {
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial; } catch { return initial; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
      return [state, setState];
    }

    function splitRows(text) { return text.split(/\r?\n/).filter(Boolean); }
    function parseCSVLine(line) {
      // Simple state machine for portability
      const res = []; let curr = "", inQuotes = false;
      for (let i=0;i<line.length;i++) {
        const ch = line[i];
        if (ch === '"') { if (inQuotes && line[i+1] === '"') { curr += '"'; i++; } else { inQuotes = !inQuotes; } }
        else if (ch === ',' && !inQuotes) { res.push(curr); curr = ""; }
        else { curr += ch; }
      }
      res.push(curr);
      return res;
    }
    function csvToItems(text) {
      const rows = splitRows(text); if (!rows.length) return [];
      const headers = parseCSVLine(rows[0]).map(h => h.replace(/^"|"$/g, ""));
      const idx = (k) => headers.indexOf(k);
      const out = [];
      for (let i=1;i<rows.length;i++) {
        const cols = parseCSVLine(rows[i]);
        out.push({
          id: uid(),
          name: cols[idx("Name")] || "",
          category: cols[idx("Category")] || categories[0],
          quantity: Number(cols[idx("Quantity")] || 0),
          location: cols[idx("Location")] || "",
          vendor: cols[idx("Vendor")] || "",
          unitCost: cols[idx("Unit Cost")] || "",
          minQty: Number(cols[idx("Min Qty")] || 0),
          notes: cols[idx("Notes")] || "",
        });
      }
      return out;
    }

    function CSVButton({ items }) {
      const handleDownload = () => {
        const headers = ["Name","Category","Quantity","Location","Vendor","Unit Cost","Min Qty","Notes"];
        const rows = items.map(i => [i.name, i.category, i.quantity, i.location, i.vendor, i.unitCost, i.minQty, (i.notes||"").replace(/\n/g," ")]);
        const csv = [headers.join(","), ...rows.map(r => r.map(x => `"${String(x).replaceAll('"','""')}"`).join(","))].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `custodial-inventory-${new Date().toISOString().slice(0,10)}.csv`; a.click();
        URL.revokeObjectURL(url);
      };
      return <button onClick={handleDownload} className="px-3 py-2 rounded-xl bg-white border shadow-sm text-gray-900">Export CSV</button>;
    }

    function ItemForm({ initial, onSave, onCancel }) {
      const [item, setItem] = useState(initial);
      const setField = (k, v) => setItem(p => ({...p, [k]: v}));
      return (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-4">
          <div className="w-full max-w-xl rounded-2xl bg-white p-4 sm:p-6 shadow-2xl text-gray-900">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-xl font-semibold">{initial.id ? "Edit Item" : "New Item"}</h2>
              <button onClick={onCancel} className="px-3 py-1.5 rounded-xl bg-gray-100 text-gray-900">Close</button>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div className="flex flex-col gap-1"><label className="text-sm">Name</label><input className="border rounded-xl px-3 py-2 bg-white text-gray-900" value={item.name} onChange={e=>setField("name", e.target.value)} placeholder="Floor Cleaner" /></div>
              <div className="flex flex-col gap-1"><label className="text-sm">Category</label><select className="border rounded-xl px-3 py-2 bg-white text-gray-900" value={item.category} onChange={e=>setField("category", e.target.value)}>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
              <div className="flex flex-col gap-1"><label className="text-sm">Quantity</label><input type="number" className="border rounded-xl px-3 py-2 bg-white text-gray-900" value={item.quantity} onChange={e=>setField("quantity", Number(e.target.value||0))} /></div>
              <div className="flex flex-col gap-1"><label className="text-sm">Min Qty (alert)</label><input type="number" className="border rounded-xl px-3 py-2 bg-white text-gray-900" value={item.minQty} onChange={e=>setField("minQty", Number(e.target.value||0))} /></div>
              <div className="flex flex-col gap-1"><label className="text-sm">Location</label><input className="border rounded-xl px-3 py-2 bg-white text-gray-900" value={item.location} onChange={e=>setField("location", e.target.value)} placeholder="Custodial Closet A" /></div>
              <div className="flex flex-col gap-1"><label className="text-sm">Vendor</label><input className="border rounded-xl px-3 py-2 bg-white text-gray-900" value={item.vendor} onChange={e=>setField("vendor", e.target.value)} placeholder="Staples" /></div>
              <div className="flex flex-col gap-1"><label className="text-sm">Unit Cost ($)</label><input type="number" className="border rounded-xl px-3 py-2 bg-white text-gray-900" value={item.unitCost} onChange={e=>setField("unitCost", e.target.value)} /></div>
              <div className="flex flex-col gap-1 sm:col-span-2"><label className="text-sm">Notes</label><textarea className="border rounded-xl px-3 py-2 bg-white text-gray-900 min-h-[80px]" value={item.notes} onChange={e=>setField("notes", e.target.value)} /></div>
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={onCancel} className="px-3 py-2 rounded-xl bg-gray-100 text-gray-900">Cancel</button>
              <button onClick={()=>onSave(item)} className="px-4 py-2 rounded-xl bg-emerald-600 text-white shadow hover:bg-emerald-700">Save</button>
            </div>
          </div>
        </div>
      );
    }

    function ItemCard({ item, onEdit, onDelete }) {
      const isLow = Number(item.quantity) <= Number(item.minQty);
      return (
        <div className={"rounded-2xl border bg-white shadow-sm p-4 text-gray-900 flex flex-col gap-2 " + (isLow ? "border-rose-400" : "")}>
          <div className="flex items-start justify-between">
            <div>
              <div className="text-lg font-semibold">{item.name || "(No name)"}</div>
              <div className="text-sm text-gray-500">{item.category}</div>
              <div className="text-sm">Qty: {item.quantity} {isLow && <span className="text-rose-600">(Low!)</span>}</div>
            </div>
            <div className="text-right">
              {item.unitCost && <div className="text-sm">${item.unitCost}/ea</div>}
              {item.vendor && <div className="text-xs text-gray-500">{item.vendor}</div>}
            </div>
          </div>
          {item.location && <div className="text-sm">📍 {item.location}</div>}
          {item.notes && <div className="text-sm text-gray-700 whitespace-pre-wrap">{item.notes}</div>}
          <div className="flex justify-end gap-2 pt-2">
            <button onClick={()=>onEdit(item)} className="px-3 py-1.5 rounded-xl bg-gray-100 text-gray-900">Edit</button>
            <button onClick={()=>onDelete(item)} className="px-3 py-1.5 rounded-xl bg-rose-600 text-white">Delete</button>
          </div>
        </div>
      );
    }

    function CSVButtonRow({ filtered, setItems }) {
      const fileRef = React.useRef(null);
      const importClick = () => fileRef.current?.click();
      const onImport = (rows) => setItems(prev => [...rows, ...prev]);
      const onFile = (e) => {
        const f = e.target.files?.[0]; if (!f) return; const r = new FileReader();
        r.onload = () => { try { const items = csvToItems(String(r.result)); onImport(items); } catch { alert("CSV parse error"); } };
        r.readAsText(f);
      };
      return (
        <div className="flex gap-2">
          <button className="px-4 py-2 rounded-xl bg-white border shadow-sm text-gray-900" onClick={()=>{}}>—</button>
        </div>
      );
    }

    function App() {
      const [items, setItems] = useLocalStorage("custodial_inventory_v1", preloadItems);
      const [search, setSearch] = useState("");
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);

      const seedFromBid = () => {
        const seeds = SEED_ITEMS.map(s => ({...emptyItem(), name: s.name, category: s.category }));
        setItems(prev => {
          const names = new Set(prev.map(i => i.name));
          const toAdd = seeds.filter(s => !names.has(s.name));
          return [...toAdd, ...prev];
        });
      };

      const filtered = useMemo(() => {
        let out = [...items];
        if (search.trim()) {
          const q = search.toLowerCase();
          out = out.filter(i => [i.name, i.category, i.location, i.vendor, i.notes].filter(Boolean).some(t => String(t).toLowerCase().includes(q)));
        }
        return out.sort((a,b)=>a.name.localeCompare(b.name));
      }, [items, search]);

      const saveItem = (item) => {
        setItems(prev => prev.some(i => i.id === item.id) ? prev.map(i => i.id === item.id ? item : i) : [item, ...prev]);
        setShowForm(false);
      };
      const deleteItem = (item) => { if (confirm(`Delete ${item.name}?`)) setItems(prev => prev.filter(i => i.id !== item.id)); };
      const editItem = (item) => { setEditing(item); setShowForm(true); };

      return (
        <div className="min-h-screen bg-gradient-to-b from-orange-600 to-orange-800 text-white p-3 sm:p-6">
          <div className="max-w-4xl mx-auto">
            <header className="flex items-center justify-between gap-3 mb-4">
              <div className="flex items-center gap-3">
                <img src="assets/thcsd-logo.png" alt="Taconic Hills Buildings & Grounds" className="w-10 h-10 rounded-full bg-white p-1" />
                <div>
                  <h1 className="text-2xl sm:text-3xl font-bold">Custodial Inventory</h1>
                  <p className="text-white/80 text-sm">Taconic Hills CSD – Buildings & Grounds</p>
                </div>
              </div>
            </header>

            <div className="rounded-2xl bg-white/10 backdrop-blur p-3 sm:p-4 border border-white/20 mb-4">
              <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
                <input className="flex-1 px-3 py-2 rounded-xl border bg-white text-gray-900" placeholder="Search items..." value={search} onChange={e=>setSearch(e.target.value)} />
                <div className="flex gap-2">
                  <button onClick={()=>{ setEditing(null); setShowForm(true); }} className="px-4 py-2 rounded-xl bg-white border shadow-sm text-gray-900">+ New Item</button>
                  <button onClick={seedFromBid} className="px-3 py-2 rounded-xl bg-white border shadow-sm text-gray-900">Seed from Bid Packet</button>
                  <CSVButton items={filtered} />
                  {/* Import button */}
                  <label className="px-3 py-2 rounded-xl bg-white border shadow-sm text-gray-900 cursor-pointer">
                    Import CSV
                    <input type="file" accept=".csv" className="hidden" onChange={(e)=>{
                      const f = e.target.files?.[0]; if (!f) return; const r = new FileReader();
                      r.onload = () => { try { const items = csvToItems(String(r.result)); setItems(prev => [...items, ...prev]); } catch { alert("CSV parse error"); } };
                      r.readAsText(f);
                    }}/>
                  </label>
                </div>
              </div>
            </div>

            <main className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              {filtered.map(item => (<ItemCard key={item.id} item={item} onEdit={editItem} onDelete={deleteItem} />))}
              {filtered.length === 0 && (
                <div className="rounded-2xl bg-white p-6 text-center shadow-sm text-gray-900">
                  <div className="text-lg font-semibold">No items yet</div>
                  <div className="text-gray-500">Tap "New Item" to add your first one.</div>
                </div>
              )}
            </main>
          </div>
          {showForm && (<ItemForm initial={editing || emptyItem()} onSave={saveItem} onCancel={()=>setShowForm(false)} />)}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
